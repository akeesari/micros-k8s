<!-- Elements added to main will be displayed on all pages -->

<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Build and Deploy Microservices on Kubernetes using ArgoCD & Helm Azure and Azure DevOps Pipelines.">
      
      
        <meta name="author" content="Anji Keesari">
      
      
        <link rel="canonical" href="https://akeesari.github.io/micros-k8s/azure/6-tf-foundation-1/">
      
      
        <link rel="prev" href="../3-azure-account-subscription/">
      
      
        <link rel="next" href="../6-tf-foundation-2/">
      
      
      <link rel="icon" href="../../assets/ak-logo.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Setup Terraform Foundation Part-1 - Microservices with Kubernetes (Developer User Guide)</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-KR7ZFHXJM1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-KR7ZFHXJM1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-KR7ZFHXJM1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Microservices with Kubernetes (Developer User Guide)" class="md-header__button md-logo" aria-label="Microservices with Kubernetes (Developer User Guide)" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Microservices with Kubernetes (Developer User Guide)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Setup Terraform Foundation Part-1
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../gettingstarted/toc/" class="md-tabs__link">
          
  
  
    
  
  Getting started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../microservices/0.gettingstarted/" class="md-tabs__link">
          
  
  
    
  
  Microservices

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../1-iac/" class="md-tabs__link">
          
  
  
    
  
  Azure (IaC)

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../kubernetes/0.getting-started/" class="md-tabs__link">
          
  
  
    
  
  Kubernetes

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../devops/1-devops-overview/" class="md-tabs__link">
          
  
  
    
  
  Azure DevOps

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../argocd/1-argocd-intro/" class="md-tabs__link">
          
  
  
    
  
  Argo CD

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../helmchart/1-introduction/" class="md-tabs__link">
          
  
  
    
  
  Helm Charts

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Microservices with Kubernetes (Developer User Guide)" class="md-nav__button md-logo" aria-label="Microservices with Kubernetes (Developer User Guide)" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    Microservices with Kubernetes (Developer User Guide)
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/toc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Table of Contents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/about-author/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About the Author
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/acknowledgments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Acknowledgments
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/lab-format/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab Format
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Microservices
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Microservices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/0.gettingstarted/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started with Microservices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/0-docker-getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started with Docker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/1.aspnet-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Containerize a .NET Core Web API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/2.node-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Containerize a Node.js API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/3.aspnet-app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Containerize a .NET Core MVC Application
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/4.react-app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Containerize a React.js Application
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/6.sqlserver-db/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Your First Database with SQL server
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/7.postgresql-db/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Your Second Database with PostgreSQL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/8.keycloak/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running Keycloak application in a Docker Container
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../microservices/9.drupal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running Drupal Website in a Docker Container
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Azure (IaC)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Azure (IaC)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1-iac/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Infrastructure as Code (IaC)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1-microservices-architecture-on-aks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Microservices Architecture on AKS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3-azure-account-subscription/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Azure Account & Subscription Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Setup Terraform Foundation Part-1
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Setup Terraform Foundation Part-1
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#technical-scenario" class="md-nav__link">
    <span class="md-ellipsis">
      Technical Scenario
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objective" class="md-nav__link">
    <span class="md-ellipsis">
      Objective
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#high-level-components" class="md-nav__link">
    <span class="md-ellipsis">
      High Level components
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation details
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-1-create-a-new-project-in-azure-devops" class="md-nav__link">
    <span class="md-ellipsis">
      Task-1: Create a new project in azure DevOps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-2-create-a-new-azure-devops-repo-for-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Task-2: Create a new Azure DevOps Repo for terraform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-3-clone-the-git-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Task-3: Clone the git repo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-4-add-gitignore-file-in-the-git-repo-for-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Task-4: Add .gitignore file in the git repo for terraform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-management-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Management Setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-5-create-terraform-service-principle-credentials" class="md-nav__link">
    <span class="md-ellipsis">
      Task-5: Create Terraform Service Principle Credentials
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-6-create-new-resource-group" class="md-nav__link">
    <span class="md-ellipsis">
      Task-6: Create new resource group
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-7-create-new-storage-account-container" class="md-nav__link">
    <span class="md-ellipsis">
      Task-7: Create new storage account &amp; container
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-8-create-new-key-vault" class="md-nav__link">
    <span class="md-ellipsis">
      Task-8: Create new Key vault
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-9-create-secrets-in-key-vault" class="md-nav__link">
    <span class="md-ellipsis">
      Task-9: Create secrets in Key Vault
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-10-setup-access-policy-in-key-vault" class="md-nav__link">
    <span class="md-ellipsis">
      Task-10: Setup Access Policy in Key Vault
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-11-configure-service-principal-role-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      Task-11: Configure Service Principal Role Assignment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-terraform-management-using-powershell-script" class="md-nav__link">
    <span class="md-ellipsis">
      Create terraform management using PowerShell Script.
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-azure-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Verify Azure resources
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6-tf-foundation-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup Terraform Foundation Part-2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../7-log-analytics-workspace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Log Analytics Workspace using terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../8-vnet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Virtual Network using terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../9-acr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Azure Container Registry (ACR) using terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../10-app-gateway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Azure Application Gateway using terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11-aks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Azure Kubernetes Service (AKS) using terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../12-postgresql/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Azure PostgreSQL - Flexible Server using terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../13-key-vault/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Azure Key Vault using Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../14-redis-cache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Azure Cache for Redis using Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../15-storage-account/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Storage Account using Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../16-event-hubs-part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Azure Event Hubs Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../16-event-hubs-part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Azure Event Hubs using Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../17-cdn-frontdoor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Front Door and CDN profile using Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Kubernetes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Kubernetes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/0.getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started with Docker Container
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/1-prepare-app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prepare an application for Azure Kubernetes Service (AKS)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/2-deploy-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deploying an .NET Core API to Azure Kubernetes Service (AKS)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/2-deploy-app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deploying an ASP.NET Core MVC to Azure Kubernetes Service (AKS)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/3-working-with-aks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working with AKS cluster using kubectl
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/4-ingress-controller-nginx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup NGINX ingress controller in AKS using Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/4.1-ingress-controller-agic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup Application Gateway ingress controller (AGIC) in AKS using Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/5-cert-manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup Cert-Manager in AKS using Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/5.1-issue-cert/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Issue the Let's Encrypt SSL Certificate to the Website
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/5.2-cert-troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting Problems with Let's Encrypt Certificates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/6-aks-kv-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Integrating Azure Key Vault with AKS using Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/pod-troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kubernetes Pod troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/aks-create-nodepool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create a new user node pool in AKS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/aks-upgrade-nodepool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Upgrade or Resize node pools in AKS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_15" >
        
          
          <label class="md-nav__link" for="__nav_5_15" id="__nav_5_15_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Monitoring
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_15">
            <span class="md-nav__icon md-icon"></span>
            Monitoring
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/monitoring/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Monitor AKS Cluster Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/monitoring/monitor-workspace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create an Azure Monitoring Workspace Using Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/monitoring/grafana-workspace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create an Azure Managed Grafana workspace Using Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Azure DevOps
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Azure DevOps
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/1-devops-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Azure DevOps Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/pipelines/1-service-connections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Your First service connection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/pipelines/2-pipeline-aspnet-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Pipeline for .NET Core Web API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/pipelines/3-pipeline-aspnet-app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Pipeline for ASP.NET Core MVC Project
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Argo CD
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Argo CD
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argocd/1-argocd-intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Argo CD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argocd/2-install-argocd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Argo CD in Kubernetes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argocd/3-install-argocd-cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install & Interact with ArgoCDÂ CLI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argocd/register-cluster/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Registering an AKS Cluster with Argo CD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argocd/deploy-app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deploy Your First application with Argo CD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argocd/argocd-project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create new ArgoCD Project
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argocd/argocd-repo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create new Repository in ArgoCD
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Helm Charts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Helm Charts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/1-introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Helmcharts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/2-create-helm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Your First Helmchart
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/3-helm-cmds/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Frequently used Helm commands details
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/4-helm-microservices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create Helmchart for Microservices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/5-install-pgadmin4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install pgadmin4 in AKS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/6-install-grafana/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Grafana in AKS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/7-install-grafana-loki-stack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Grafana Loki-Stack in AKS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/8-install-redis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Redis in AKS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/9-install-minio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Minio in AKS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/10-install-adcs-issuer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install ADCS Issuer in AKS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/11-install-jaeger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Jaeger in AKS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helmchart/12-install-otel-operator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install OpenTelemetry Operator in AKS
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#technical-scenario" class="md-nav__link">
    <span class="md-ellipsis">
      Technical Scenario
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objective" class="md-nav__link">
    <span class="md-ellipsis">
      Objective
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#high-level-components" class="md-nav__link">
    <span class="md-ellipsis">
      High Level components
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation details
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-1-create-a-new-project-in-azure-devops" class="md-nav__link">
    <span class="md-ellipsis">
      Task-1: Create a new project in azure DevOps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-2-create-a-new-azure-devops-repo-for-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Task-2: Create a new Azure DevOps Repo for terraform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-3-clone-the-git-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Task-3: Clone the git repo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-4-add-gitignore-file-in-the-git-repo-for-terraform" class="md-nav__link">
    <span class="md-ellipsis">
      Task-4: Add .gitignore file in the git repo for terraform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-management-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Terraform Management Setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-5-create-terraform-service-principle-credentials" class="md-nav__link">
    <span class="md-ellipsis">
      Task-5: Create Terraform Service Principle Credentials
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-6-create-new-resource-group" class="md-nav__link">
    <span class="md-ellipsis">
      Task-6: Create new resource group
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-7-create-new-storage-account-container" class="md-nav__link">
    <span class="md-ellipsis">
      Task-7: Create new storage account &amp; container
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-8-create-new-key-vault" class="md-nav__link">
    <span class="md-ellipsis">
      Task-8: Create new Key vault
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-9-create-secrets-in-key-vault" class="md-nav__link">
    <span class="md-ellipsis">
      Task-9: Create secrets in Key Vault
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-10-setup-access-policy-in-key-vault" class="md-nav__link">
    <span class="md-ellipsis">
      Task-10: Setup Access Policy in Key Vault
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-11-configure-service-principal-role-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      Task-11: Configure Service Principal Role Assignment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-terraform-management-using-powershell-script" class="md-nav__link">
    <span class="md-ellipsis">
      Create terraform management using PowerShell Script.
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-azure-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Verify Azure resources
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Setup Terraform Foundation Part-1</h1>

<h2 id="introduction">Introduction</h2>
<p>Welcome to Part 1 of the Terraform Foundation lab. In this lab, we will set up the <code>Terraform Management</code> environment, enabling you to create Azure resources using Terraform. As part of this setup, we will create a Azure Blob storage account for storing the Terraform state and an Azure Key Vault for securing the Terraform Secrets.</p>
<p>The Terraform <code>Terraform Management</code> environment setup is a one-time activity that lays the foundation for automating infrastructure provisioning using Infrastructure as Code (IaC) principles. Once this setup is completed, you will be ready to create various Azure resources using Terraform in an automated and consistent manner.</p>
<p>Let's get started with setting up the Terraform Management environment!</p>
<h2 id="technical-scenario">Technical Scenario</h2>
<p>As a <code>Cloud Engineer</code>, you play a critical role in managing cloud infrastructure efficiently and effectively. As part of your responsibilities, you have been tasked with setting up the Terraform Management environment, which will empower your team to provision and manage cloud resources using Terraform.</p>
<p>By setting up the Terraform Management environment, you will provide your team with a centralized platform to automate the creation and management of cloud resources. This setup will streamline the deployment process, enhance collaboration, and improve the overall efficiency of your cloud infrastructure management.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Download &amp; Install Terraform</li>
<li>Download &amp; Install Azure CLI</li>
<li>Azure subscription</li>
<li>Register resource providers in the subscription</li>
<li>Visual studio code</li>
<li>Download &amp; Install Git tools</li>
<li>Basic knowledge on Terraform</li>
</ul>
<h2 id="objective">Objective</h2>
<p>In this exercise, our objective is to accomplish the following tasks and gain a deeper understanding of the Terraform Management setup:</p>
<p><strong>Azure DevOps setup</strong></p>
<ul>
<li>Task-1: Create a new project in azure DevOps</li>
<li>Task-2: Create a new Azure DevOps Repo for terraform</li>
<li>Task-3: Clone a new git repo</li>
<li>Task-4: Add .gitignore file in the git repo for terraform</li>
</ul>
<p><strong>Terraform Management setup</strong></p>
<ul>
<li>Task-5: Create terraform Service Principle </li>
<li>Task-6: Create new azure resource group</li>
<li>Task-7: Create new azure storage account &amp; container</li>
<li>Task-8: Create new azure Key vault </li>
<li>Task-9: Create secrets in azure  Key Vault </li>
<li>Task-10: Setup Access Policy in Key Vault </li>
<li>Task-11: Configure Service Principal Role Assignment </li>
<li>Task-12: Create terraform management using PowerShell Script.</li>
</ul>
<h2 id="high-level-components">High Level components</h2>
<p>The following diagram illustrates the essential components used in the Terraform management setup in this lab.</p>
<p><a href="../images/image-39.jpg" target="_blank"><img alt="Alt text" src="../images/image-39.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<h2 id="implementation-details">Implementation details</h2>
<p>In this lab, we will perform various tasks both in the Azure DevOps portal and the Azure portal to set up the Terraform Management. The following are the implementation details for each task:</p>
<h2 id="task-1-create-a-new-project-in-azure-devops">Task-1: Create a new project in azure DevOps</h2>
<p>We will create a new project in Azure DevOps to organize our Terraform-related activities and workflows. This project will serve as a central hub for managing our infrastructure as code.</p>
<p>It is always recommended to have separate project in azure DevOps for Infrastructure as Code maintenance. Here we are going to create new project called <code>IaC</code> and under this project we can create a new repo called <code>terraform</code> </p>
<p>Here are the details of the new project:</p>
<p>Project Name - <code>IaC</code></p>
<p>Project Description - <code>This project contains the source code related to Infrastructure as code (IaC), IaC is a method of provisioning and managing infrastructure using code and automation rather than manual configuration.</code></p>
<p>Follow these steps for creating a new project in azure DevOps.</p>
<ol>
<li>Sign in to your organization in Azure DevOps</li>
<li>Select New project.</li>
<li>Enter project name &amp; description</li>
</ol>
<p>Once the project is created then you can add more repos as needed.</p>
<p>For example:</p>
<ul>
<li><code>terraform</code> - you can use this repo for terraform configuration</li>
<li><code>scripts</code> - you can use this repo for managing all kinds of scripts like PowerShell, Bash and CLI etc..</li>
<li><code>bicep</code> - you can use this repo for Microsoft Bicep scripts etc..</li>
</ul>
<p><a href="../images/image-1.jpg" target="_blank"><img alt="Alt text" src="../images/image-1.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<h2 id="task-2-create-a-new-azure-devops-repo-for-terraform">Task-2: Create a new Azure DevOps Repo for terraform</h2>
<p>We will create a dedicated Git repository within Azure DevOps to store our Terraform configurations and scripts. This repository will enable version control and collaboration among team members.</p>
<p>Here are the steps to create a new Git repository in Azure DevOps:</p>
<ul>
<li>Login into azure DevOps -  <a href="https://dev.azure.com/" target="_blank">azure DevOps</a></li>
<li>Select the project where we want to create the repo</li>
<li>Click on <code>Repos</code> left nav link</li>
<li>From the repo drop-down, select <code>New repository</code></li>
<li>In the <code>Create a new repository</code> dialog, verify that Git is the repository type and enter a name for the new repository. </li>
<li>
<p>You can also add a README and create a <code>.gitignore</code> for the type of code you plan to manage in the repo.</p>
</li>
<li>
<p>use lower case for the repos (best practice)</p>
</li>
<li>repo name - terraform </li>
</ul>
<p>for example: </p>
<p><a href="../images/image-2.png" target="_blank"><img alt="Alt text" src="../images/image-2.png" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<ul>
<li>
<p>Initialize the main branch with a README or gitignore</p>
</li>
<li>
<p>Create new feature branch (develop) from main</p>
</li>
</ul>
<p><a href="../images/image-3.jpg" target="_blank"><img alt="Alt text" src="../images/image-3.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<h2 id="task-3-clone-the-git-repo">Task-3: Clone the git repo</h2>
<p>We will clone the newly created Git repository to our local machine. This will allow us to work with the Terraform configurations locally and push changes to the remote repository.</p>
<p>Here we will use the Git CMD tool, open the git cmd tool in admin mode and follow these commands to clone the code locally.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>C:\Users\anji.keesari&gt;cd c:\Source\Repos\IaC
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>c:\Source\Repos\IaC&gt;git clone https://keesari.visualstudio.com/IaC/_git/terraform
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>Cloning into &#39;terraform&#39;...
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>remote: Azure Repos
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>remote: Found 4 objects to send. (26 ms)
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>Unpacking objects: 100% (4/4), 1.22 KiB | 62.00 KiB/s, done.
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>c:\Source\Repos\IaC&gt;cd terraform
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a># open the folder in VS code
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>c:\Source\Repos\IaC\terraform&gt;code .
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>c:\Source\Repos\IaC\terraform&gt;
</span></code></pre></div>
<h2 id="task-4-add-gitignore-file-in-the-git-repo-for-terraform">Task-4: Add .gitignore file in the git repo for terraform</h2>
<p>We will add a .gitignore file to the Git repository specifically tailored for Terraform. This file will exclude unnecessary files and directories from being tracked by Git, ensuring a cleaner and more manageable repository.</p>
<p>This is the first file you need to add in the source code before commit any files.</p>
<p>This .gitignore file will prevent Terraform state files, override files, local tfvars files, and CLI configuration files from being tracked by Git. These files contain sensitive information and can cause issues with consistency and conflicts if multiple users are working on the same Terraform project. It's important to not commit these files to your source code repository to maintain the integrity and security of your infrastructure code.</p>
<p>Here is the sample file:</p>
<div class="language-text highlight"><span class="filename">.gitignore</span><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a># Local .terraform directories
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>**/.terraform/*
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a># .tfstate files
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>*.tfstate
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>*.tfstate.*
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a># Crash log files
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>crash.log
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a># Exclude all .tfvars files, which are likely to contain sentitive data, such as
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a># password, private keys, and other secrets. These should not be part of version 
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a># control as they are data points which are potentially sensitive and subject 
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a># to change depending on the environment.
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>#
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>*.tfvars
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a># Ignore override files as they are usually used to override resources locally and so
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a># are not checked in
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>override.tf
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>override.tf.json
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>*_override.tf
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>*_override.tf.json
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a># Include override files you do wish to add to version control using negated pattern
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>#
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a># !example_override.tf
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a># Include tfplan files to ignore the plan output of command: terraform plan -out=tfplan
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a># example: *tfplan*
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a># Ignore CLI configuration files
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>.terraformrc
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>terraform.rc
</span></code></pre></div>
<h2 id="terraform-management-setup">Terraform Management Setup</h2>
<p>The azure resources which are managing and securing the terraform state and securing the service principle are called <code>Terraform management resources</code></p>
<p>By following these steps, you can set up a Terraform management environment for creating Azure resources. It's important to keep your configuration files and state file in a secure location, and to follow best practices for managing infrastructure as code.</p>
<p>Here we are going to use Azure Storage Account for storing the terraform state files and Azure Key vault for securing the secrets used for running the terraform configuration in azure.</p>
<p>Since these steps are part of terraform setup itself,  we can't create following resources using terraform, here we can use either az cli or PowerShell script to create following resources. I'll be showing the az cli and PowerShell script for creating these resources.</p>
<p>We are going to create separate azure resource group for managing terraform management specific azure resource like azure storage account and azure key vault.</p>
<p>We will start with service principe before creating azure storage account and azure key vault.</p>
<h2 id="task-5-create-terraform-service-principle-credentials">Task-5: Create Terraform Service Principle Credentials</h2>
<p>A Service Principal is an identity that Terraform can use to authenticate and manage Azure resources.  Terraform uses a Service Principal to authenticate with Azure and manage Azure resources, such as virtual machines, storage accounts, and databases.</p>
<p>Here's how you can create a Service Principal in Azure for use with Terraform:</p>
<ul>
<li>Log in to the Azure portal and go to the Azure Active Directory (AD) section.</li>
<li>Click on "App registrations" and then click "New registration".</li>
<li>Provide a name for the application and select "Accounts in this organizational directory only" as the supported account type.</li>
<li>For the "Redirect URI" field, select "Web" and enter a valid URI. This URI can be any valid URI, but it must be accessible to the application.</li>
<li>Click on "Register" to create the application registration.
Once the application is created, note down the "Application ID" and "Directory (tenant) ID" values. These will be used in the Terraform configuration.</li>
<li>Create a client secret by clicking on "Certificates &amp; secrets" and then "New client secret". Note down the client secret value that is generated. This value will be used in the Terraform configuration.</li>
</ul>
<p>Now that you have created a Service Principal in Azure, you can use it in Terraform to authenticate with Azure and manage Azure resources. In your Terraform configuration file, you can add the following code to authenticate with Azure using the Service Principal:</p>
<div class="language-tf highlight"><span class="filename">provider.tf</span><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;azurerm&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="na">subscription_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SUBSCRIPTION_ID&quot;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span><span class="na">client_id</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;CLIENT_ID&quot;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="na">client_secret</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;CLIENT_SECRET&quot;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">  </span><span class="na">tenant_id</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;TENANT_ID&quot;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>Replace SUBSCRIPTION_ID, CLIENT_ID, CLIENT_SECRET, and TENANT_ID with the values you obtained when creating the Service Principal in Azure. </p>
<!-- 
1. Assign a role to the service principal: Use the Azure portal or Azure CLI to assign a role to the service principal. This will determine the level of access that the service principal has to Azure resources. -->

<p>additional az cli commands may be helpful.</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">az</span> <span class="n">login</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">az</span> <span class="n">ad</span> <span class="n">app</span> <span class="n">create</span> <span class="p">-</span><span class="n">-display-name</span> <span class="p">&lt;</span><span class="n">APP_NAME</span><span class="p">&gt;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">az</span> <span class="n">ad</span> <span class="n">app</span> <span class="n">create</span> <span class="p">-</span><span class="n">-display-name</span> <span class="s2">&quot;sp-tfmgmt-dev&quot;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">az</span> <span class="n">ad</span> <span class="n">app</span> <span class="n">show</span> <span class="p">-</span><span class="n">-id</span> <span class="p">&lt;</span><span class="n">APP_ID</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-query</span> <span class="s2">&quot;appId&quot;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="n">az</span> <span class="n">account</span> <span class="n">show</span> <span class="p">-</span><span class="n">-query</span> <span class="s2">&quot;tenantId&quot;</span>
</span></code></pre></div>
<p><a href="../images/image-7.jpg" target="_blank"><img alt="Alt text" src="../images/image-7.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<h2 id="task-6-create-new-resource-group">Task-6: Create new resource group</h2>
<p>To maintain the Terraform management resources in Azure, we will create a separate resource group specifically for this purpose.</p>
<p>Resource Group Name - <code>rg-tfmgmt-dev</code> </p>
<p>You can use the following Azure CLI command to create the resource group:</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">az</span> <span class="nb">group </span><span class="n">create</span> <span class="p">-</span><span class="n">-name</span> <span class="p">&lt;</span><span class="n">GROUP_NAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-location</span> <span class="p">&lt;</span><span class="n">LOCATION</span><span class="p">&gt;</span>
</span></code></pre></div>
<p>For example:</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">az</span> <span class="nb">group </span><span class="n">create</span> <span class="n">-n</span> <span class="s2">&quot;rg-tfmgmt-dev&quot;</span><span class="n">-l</span> <span class="s2">&quot;east us&quot;</span>
</span></code></pre></div>
<p><a href="../images/image-8.jpg" target="_blank"><img alt="Alt text" src="../images/image-8.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<h2 id="task-7-create-new-storage-account-container">Task-7: Create new storage account &amp; container</h2>
<p>To store the Terraform remote state, we will create an Azure Storage Account. This will allow us to store the state file remotely and access it from anywhere, while also providing additional features such as versioning, locking, and auditing.</p>
<p>Terraform remote state is a way to store and manage Terraform's state files remotely. By default, Terraform stores the state file on the local file system, but this can cause problems when working in a team or when scaling up infrastructure. Remote state storage provides a centralized location for storing state files, which makes it easier to manage state across teams and across environments.</p>
<p>Here is the command to create a new Azure Storage Account using the Azure CLI:</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">az</span> <span class="n">storage</span> <span class="n">account</span> <span class="n">create</span> <span class="p">-</span><span class="n">-name</span> <span class="p">&lt;</span><span class="n">ACCOUNT_NAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-resource-group</span> <span class="p">&lt;</span><span class="n">RESOURCE_GROUP_NAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-location</span> <span class="p">&lt;</span><span class="n">LOCATION</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-sku</span> <span class="p">&lt;</span><span class="n">SKU</span><span class="p">&gt;</span>
</span></code></pre></div>
<p>For example:</p>
<p><div class="language-ps1 highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">az</span> <span class="n">storage</span> <span class="n">account</span> <span class="n">create</span> <span class="n">-n</span> <span class="s2">&quot;tfmgmtstates&quot;</span> <span class="n">-g</span> <span class="s2">&quot;rg-tfmgmt-dev&quot;</span> <span class="n">-l</span> <span class="s2">&quot;east us&quot;</span> <span class="p">-</span><span class="n">-sku</span> <span class="s2">&quot;Standard_LRS&quot;</span>
</span></code></pre></div>
<a href="../images/image-9.jpg" target="_blank"><img alt="Alt text" src="../images/image-9.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<p>We also need blob container for storing terraform state files, Let's create new storage account container using az cli here</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">az</span> <span class="n">storage</span> <span class="n">container</span> <span class="n">create</span> <span class="p">-</span><span class="n">-name</span> <span class="p">&lt;</span><span class="n">CONTAINER_NAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-account-name</span> <span class="p">&lt;</span><span class="n">ACCOUNT_NAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-account-key</span> <span class="p">&lt;</span><span class="n">ACCOUNT_KEY</span><span class="p">&gt;</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">az</span> <span class="n">storage</span> <span class="n">container</span> <span class="n">create</span> <span class="n">-n</span> <span class="s2">&quot;terraformstates&quot;</span> <span class="p">-</span><span class="n">-account-name</span> <span class="s2">&quot;tfmgmtstates&quot;</span> <span class="p">-</span><span class="n">-account-key</span> <span class="s2">&quot;koB5PQEGX5pEHVAWsyM0efP3aeFsuNhw8dzRXvqrLXXcD12VEIC4HkhNnwDAGWUJcZWb8Q3C8yxZ+AStXGHDGQ==&quot;</span>
</span></code></pre></div>
<p><a href="../images/image-10.jpg" target="_blank"><img alt="Alt text" src="../images/image-10.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<h2 id="task-8-create-new-key-vault">Task-8: Create new Key vault</h2>
<p>This Key Vault will be used for storing all kind of secrets related terraform management. it is very critical securing secrets like terraform service principle because these are actually used to authenticate Terraform to Azure and create azure resources in the Azure Portal.</p>
<p>create new azure key vault using az cli</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">az</span> <span class="n">keyvault</span> <span class="n">create</span> <span class="p">-</span><span class="n">-name</span> <span class="p">&lt;</span><span class="n">VAULT_NAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-resource-group</span> <span class="p">&lt;</span><span class="n">RESOURCE_GROUP_NAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-location</span> <span class="p">&lt;</span><span class="n">LOCATION</span><span class="p">&gt;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">az</span> <span class="n">keyvault</span> <span class="n">create</span> <span class="n">-n</span> <span class="s2">&quot;kv-tfstates-dev&quot;</span> <span class="n">-g</span> <span class="s2">&quot;rg-tfmgmt-dev&quot;</span> <span class="n">-l</span> <span class="s2">&quot;east us&quot;</span>
</span></code></pre></div>
<p><a href="../images/image-11.jpg" target="_blank"><img alt="Alt text" src="../images/image-11.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<h2 id="task-9-create-secrets-in-key-vault">Task-9: Create secrets in Key Vault</h2>
<p>Terraform management secrets will be protected by storing in the azure key vault.</p>
<p>Here are the commands to create and store secrets in the Azure Key Vault using the Azure CLI:</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">az</span> <span class="n">keyvault</span> <span class="n">secret</span> <span class="nb">set </span><span class="p">-</span><span class="n">-vault-name</span> <span class="p">&lt;</span><span class="n">VAULT_NAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-name</span> <span class="p">&lt;</span><span class="n">SECRET_NAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-value</span> <span class="p">&lt;</span><span class="n">SECRET_VALUE</span><span class="p">&gt;</span>
</span></code></pre></div>
<p>For example:</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">az</span> <span class="n">keyvault</span> <span class="n">secret</span> <span class="nb">set </span><span class="p">-</span><span class="n">-vault-name</span> <span class="s2">&quot;kv-tfstates-dev&quot;</span> <span class="p">-</span><span class="n">-name</span> <span class="s2">&quot;tf-subscription-id&quot;</span> <span class="p">-</span><span class="n">-value</span> <span class="s2">&quot;1115d52c-5170-4366-b262-cc12cba2d222&quot;</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">az</span> <span class="n">keyvault</span> <span class="n">secret</span> <span class="nb">set </span><span class="p">-</span><span class="n">-vault-name</span> <span class="s2">&quot;kv-tfstates-dev&quot;</span> <span class="p">-</span><span class="n">-name</span> <span class="s2">&quot;tf-client-id&quot;</span> <span class="p">-</span><span class="n">-value</span> <span class="s2">&quot;11183cf3-7184-457a-a71b-eb5fb7e02222&quot;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">az</span> <span class="n">keyvault</span> <span class="n">secret</span> <span class="nb">set </span><span class="p">-</span><span class="n">-vault-name</span> <span class="s2">&quot;kv-tfstates-dev&quot;</span> <span class="p">-</span><span class="n">-name</span> <span class="s2">&quot;tf-client-secret&quot;</span> <span class="p">-</span><span class="n">-value</span> <span class="s2">&quot;1118Q~eQTMTWEwpvK~CHeTIrU7l7xnhw9wE1z222&quot;</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="n">az</span> <span class="n">keyvault</span> <span class="n">secret</span> <span class="nb">set </span><span class="p">-</span><span class="n">-vault-name</span> <span class="s2">&quot;kv-tfstates-dev&quot;</span> <span class="p">-</span><span class="n">-name</span> <span class="s2">&quot;tf-tenant-id&quot;</span> <span class="p">-</span><span class="n">-value</span> <span class="s2">&quot;1113c4a0-f87d-46ad-b4be-3ee05cefe222&quot;</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">az</span> <span class="n">keyvault</span> <span class="n">secret</span> <span class="nb">set </span><span class="p">-</span><span class="n">-vault-name</span> <span class="s2">&quot;kv-tfstates-dev&quot;</span> <span class="p">-</span><span class="n">-name</span> <span class="s2">&quot;tf-access-key&quot;</span> <span class="p">-</span><span class="n">-value</span> <span class="s2">&quot;1115PQEGX5pEHVAWsyM0efP3aeFsuNhw8dzRXvqrLXXcD12VEIC4HkhNnwDAGWUJcZWb8Q3C8yxZ+AStXGHDG222&quot;</span>
</span></code></pre></div>
<p><a href="../images/image-12.jpg" target="_blank"><img alt="Alt text" src="../images/image-12.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<p>Make sure to store sensitive information, such as passwords or access keys, as secrets in the Azure Key Vault to maintain security and compliance.</p>
<h2 id="task-10-setup-access-policy-in-key-vault">Task-10: Setup Access Policy in Key Vault</h2>
<p>To grant access to the Terraform service principal to retrieve the secrets stored in the Azure Key Vault, we need to set up an access policy in the Key Vault.</p>
<p>Use the following command to set up the access policy using the Azure CLI:</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">az</span> <span class="n">keyvault</span> <span class="nb">set-policy</span> <span class="p">-</span><span class="n">-name</span> <span class="p">&lt;</span><span class="n">VAULT_NAME</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-object-id</span> <span class="p">&lt;</span><span class="n">OBJECT_ID</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-secret-permissions</span> <span class="p">&lt;</span><span class="n">SECRET_PERMISSIONS</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-key-permissions</span> <span class="p">&lt;</span><span class="n">KEY_PERMISSIONS</span><span class="p">&gt;</span>
</span></code></pre></div>
<p>For example:</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">az</span> <span class="n">keyvault</span> <span class="nb">set-policy</span> <span class="p">-</span><span class="n">-name</span> <span class="s2">&quot;kv-tfstates-dev&quot;</span> <span class="p">-</span><span class="n">-object-id</span> <span class="s2">&quot;a68e4529-b584-43c6-9ffd-4ca681da9efc&quot;</span> <span class="p">-</span><span class="n">-secret-permissions</span> <span class="n">get</span> <span class="n">list</span> <span class="p">-</span><span class="n">-key-permissions</span> <span class="n">get</span> <span class="n">list</span>
</span></code></pre></div>
<p><a href="../images/image-6.jpg" target="_blank"><img alt="Alt text" src="../images/image-6.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<h2 id="task-11-configure-service-principal-role-assignment">Task-11: Configure Service Principal Role Assignment</h2>
<p>The new Service principle needs at least contributor access at subscription level where azure resources will be created, 
if you want avoid unnecessary issues during resources creation or azure DevOps terraform automation you can even provide owner role at subscription level so that we don't run any issues while creating azure resource from terraform configuration.</p>
<p>Use the following command to assign the role to the service principal using the Azure CLI:</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">az</span> <span class="n">role</span> <span class="n">assignment</span> <span class="n">create</span> <span class="p">-</span><span class="n">-assignee-object-id</span> <span class="p">&lt;</span><span class="n">SERVICE_PRINCIPAL_OBJECT_ID</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-role</span> <span class="n">Owner</span> <span class="p">-</span><span class="n">-scope</span> <span class="p">&lt;</span><span class="n">SCOPE</span><span class="p">&gt;</span>
</span></code></pre></div>
<p>For example:</p>
<div class="language-ps1 highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">az</span> <span class="n">role</span> <span class="n">assignment</span> <span class="n">create</span> <span class="p">-</span><span class="n">-assignee-object-id</span> <span class="s2">&quot;a68e4529-b584-43c6-9ffd-4ca681da9efc&quot;</span> <span class="p">-</span><span class="n">-role</span> <span class="n">Owner</span> <span class="p">-</span><span class="n">-scope</span> <span class="s2">&quot;/subscriptions/b635d52c-5170-4366-b262-cc12cba2d9be&quot;</span> 
</span></code></pre></div>
<p>Note:- make sure that you will get the service principle object id here instead of app registration object id
service principle object id will be found in <code>Enterprise Application</code></p>
<p><a href="../images/image-13.jpg" target="_blank"><img alt="Alt text" src="../images/image-13.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<p>That it! now you've setup terraform management for running your terraform configuration.</p>
<h2 id="create-terraform-management-using-powershell-script">Create terraform management using PowerShell Script.</h2>
<p>Alternately you can also use the re-usable PowerShell script to do above steps which is more efficient way:</p>
<p>Here is the re-usable and re-runnable PowerShell function to create terraform management resources; this function will allow you to run in multiple environments.</p>
<p>Let's look at the complete PowerShell script file together.</p>
<div class="language-ps1 highlight"><span class="filename">tf-mgmt.ps1</span><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="cm">&lt;#</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="sd">.SYNOPSIS</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="cm">    Configures Azure for secure Terraform access.</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="sd">.DESCRIPTION</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="cm">    Configures Azure for secure Terraform access using Azure Key Vault.</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="cm">    The following steps are automated:</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="cm">    - Creates an Azure Service Principle for Terraform.</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="cm">    - Creates a new Resource Group.</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="cm">    - Creates a new Storage Account.</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="cm">    - Creates a new Storage Container.</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="cm">    - Creates a new Key Vault.</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="cm">    - Configures Key Vault Access Policies.</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="cm">    - Creates Key Vault Secrets for these sensitive Terraform login details:</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="cm">       - &#39;tf-subscription-id&#39;</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="cm">       - &#39;tf-client-id&#39;</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="cm">       - &#39;tf-client-secret&#39;</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="cm">       - &#39;tf-tenant-id&#39;   </span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="cm">       - &#39;tf-access-key&#39; </span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="sd">.EXAMPLE</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="cm">    Connect-AzAccount -UseDeviceAuthentication</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="cm">    .\scripts\TerraformManagement.ps1 -adminUserDisplayName &#39;AnjKeesari@gmail.com&#39;</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="cm">    Displays device login link, then configures secure Terraform access for admin user &#39;AnjKeesari@gmail.com&#39;</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="sd">.NOTES</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="cm">    Assumptions:</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="cm">    - Azure PowerShell module is installed: https://docs.microsoft.com/en-us/powershell/azure/install-az-ps</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="cm">    - You are already logged into Azure before running this script (eg. Connect-AzAccount)</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="cm">    - Use &quot;Connect-AzAccount -UseDeviceAuthentication&quot; if browser prompts don&#39;t work.</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="cm">    - select-AzSubscription -SubscriptionName &#39;Dev&#39;</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="cm">#&gt;</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="p">[</span><span class="k">CmdletBinding</span><span class="p">()]</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="k">param</span> <span class="p">(</span>    
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>    <span class="nv">$adminUserDisplayName</span> <span class="p">=</span> <span class="s2">&quot;anjkeesari@gmail.com&quot;</span><span class="p">,</span><span class="c"># This is used to assign yourself access to KeyVault</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>    <span class="nv">$servicePrincipalName</span> <span class="p">=</span> <span class="s2">&quot;sp-tfmgmt-dev&quot;</span><span class="p">,</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>    <span class="nv">$resourceGroupName</span> <span class="p">=</span> <span class="s2">&quot;rg-tfmgmt-dev&quot;</span><span class="p">,</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>    <span class="nv">$location</span> <span class="p">=</span> <span class="s2">&quot;East US&quot;</span><span class="p">,</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>    <span class="nv">$storageAccountSku</span> <span class="p">=</span> <span class="s2">&quot;Standard_LRS&quot;</span><span class="p">,</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>    <span class="nv">$storageContainerName</span> <span class="p">=</span> <span class="s2">&quot;tfmgmttates&quot;</span><span class="p">,</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>    <span class="nv">$vaultName</span> <span class="p">=</span> <span class="s2">&quot;kv-tfstates-dev&quot;</span><span class="p">,</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>    <span class="nv">$storageAccountName</span> <span class="p">=</span> <span class="s2">&quot;sttfstatesdev&quot;</span><span class="p">,</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a>    <span class="nv">$subscriptionID</span> <span class="p">=</span> <span class="s2">&quot;111111-ffec-4773-b939-fc5be0d00222&quot;</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a><span class="p">)</span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a><span class="c"># Azure login</span>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Checking for an active Azure login...&quot;</span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a><span class="nv">$azContext</span> <span class="p">=</span> <span class="nb">Get-AzContext</span>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$azContext</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;ERROR!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Red&#39;</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a>    <span class="k">throw</span> <span class="s2">&quot;There is no active login for Azure. Please login first using &#39;Connect-AzAccount&#39;&quot;</span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a><span class="p">}</span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a><span class="nb">Write-Host</span> <span class="s2">&quot;SUCCESS!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a><span class="c"># Service Principle</span>
</span><span id="__span-16-57"><a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a><span class="nb">Write-Host</span> <span class="s2">&quot;Checking for an active Service Principle: [$servicePrincipalName]...&quot;</span>
</span><span id="__span-16-58"><a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a>
</span><span id="__span-16-59"><a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a><span class="c"># Get current context</span>
</span><span id="__span-16-60"><a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a><span class="nv">$terraformSP</span> <span class="p">=</span> <span class="nb">Get-AzADServicePrincipal</span> <span class="n">-DisplayName</span> <span class="nv">$servicePrincipalName</span>
</span><span id="__span-16-61"><a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a><span class="nb">Write-Host</span> <span class="s2">&quot;SUCCESS!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>
</span><span id="__span-16-62"><a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a>
</span><span id="__span-16-63"><a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$terraformSP</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-16-64"><a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;Creating a Terraform Service Principle: [$servicePrincipalName] ...&quot;</span>
</span><span id="__span-16-65"><a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-16-66"><a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a>        <span class="nv">$terraformSP</span> <span class="p">=</span> <span class="nb">New-AzADServicePrincipal</span> <span class="n">-DisplayName</span> <span class="nv">$servicePrincipalName</span> <span class="n">-Role</span> <span class="s1">&#39;Contributor&#39;</span> <span class="n">-ErrorAction</span> <span class="s1">&#39;Stop&#39;</span>
</span><span id="__span-16-67"><a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a>        <span class="nv">$servicePrinciplePassword</span> <span class="p">=</span> <span class="nv">$newSpCredential</span><span class="p">.</span><span class="n">secretText</span>
</span><span id="__span-16-68"><a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a>    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-16-69"><a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;ERROR!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Red&#39;</span>
</span><span id="__span-16-70"><a id="__codelineno-16-70" name="__codelineno-16-70" href="#__codelineno-16-70"></a>        <span class="k">throw</span> <span class="nv">$_</span>
</span><span id="__span-16-71"><a id="__codelineno-16-71" name="__codelineno-16-71" href="#__codelineno-16-71"></a>    <span class="p">}</span>
</span><span id="__span-16-72"><a id="__codelineno-16-72" name="__codelineno-16-72" href="#__codelineno-16-72"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;SUCCESS!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>
</span><span id="__span-16-73"><a id="__codelineno-16-73" name="__codelineno-16-73" href="#__codelineno-16-73"></a>
</span><span id="__span-16-74"><a id="__codelineno-16-74" name="__codelineno-16-74" href="#__codelineno-16-74"></a><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="__span-16-75"><a id="__codelineno-16-75" name="__codelineno-16-75" href="#__codelineno-16-75"></a>    <span class="c"># Service Principle exists so renew password (as cannot retrieve current one-off password)</span>
</span><span id="__span-16-76"><a id="__codelineno-16-76" name="__codelineno-16-76" href="#__codelineno-16-76"></a>    <span class="nv">$newSpCredential</span> <span class="p">=</span> <span class="nv">$terraformSP</span> <span class="p">|</span> <span class="nb">New-AzADSpCredential</span>
</span><span id="__span-16-77"><a id="__codelineno-16-77" name="__codelineno-16-77" href="#__codelineno-16-77"></a>    <span class="nv">$servicePrinciplePassword</span> <span class="p">=</span> <span class="nv">$newSpCredential</span><span class="p">.</span><span class="n">secretText</span>
</span><span id="__span-16-78"><a id="__codelineno-16-78" name="__codelineno-16-78" href="#__codelineno-16-78"></a><span class="p">}</span>
</span><span id="__span-16-79"><a id="__codelineno-16-79" name="__codelineno-16-79" href="#__codelineno-16-79"></a>
</span><span id="__span-16-80"><a id="__codelineno-16-80" name="__codelineno-16-80" href="#__codelineno-16-80"></a><span class="c"># Get Subscription</span>
</span><span id="__span-16-81"><a id="__codelineno-16-81" name="__codelineno-16-81" href="#__codelineno-16-81"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Finding Subscription and Tenant details...&quot;</span>
</span><span id="__span-16-82"><a id="__codelineno-16-82" name="__codelineno-16-82" href="#__codelineno-16-82"></a><span class="k">try</span> <span class="p">{</span>
</span><span id="__span-16-83"><a id="__codelineno-16-83" name="__codelineno-16-83" href="#__codelineno-16-83"></a>    <span class="nv">$subscription</span> <span class="p">=</span> <span class="nb">Get-AzSubscription</span> <span class="n">-SubscriptionID</span> <span class="nv">$subscriptionID</span> <span class="n">-ErrorAction</span> <span class="s1">&#39;Stop&#39;</span>
</span><span id="__span-16-84"><a id="__codelineno-16-84" name="__codelineno-16-84" href="#__codelineno-16-84"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-16-85"><a id="__codelineno-16-85" name="__codelineno-16-85" href="#__codelineno-16-85"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;ERROR!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Red&#39;</span>
</span><span id="__span-16-86"><a id="__codelineno-16-86" name="__codelineno-16-86" href="#__codelineno-16-86"></a>    <span class="k">throw</span> <span class="nv">$_</span>
</span><span id="__span-16-87"><a id="__codelineno-16-87" name="__codelineno-16-87" href="#__codelineno-16-87"></a><span class="p">}</span>
</span><span id="__span-16-88"><a id="__codelineno-16-88" name="__codelineno-16-88" href="#__codelineno-16-88"></a><span class="nb">Write-Host</span> <span class="s2">&quot;SUCCESS!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>
</span><span id="__span-16-89"><a id="__codelineno-16-89" name="__codelineno-16-89" href="#__codelineno-16-89"></a>
</span><span id="__span-16-90"><a id="__codelineno-16-90" name="__codelineno-16-90" href="#__codelineno-16-90"></a><span class="c"># New Resource Group</span>
</span><span id="__span-16-91"><a id="__codelineno-16-91" name="__codelineno-16-91" href="#__codelineno-16-91"></a><span class="k">if</span><span class="p">(</span><span class="nb">Get-AzResourceGroup</span> <span class="n">-Name</span> <span class="nv">$resourceGroupName</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span><span class="p">)</span>
</span><span id="__span-16-92"><a id="__codelineno-16-92" name="__codelineno-16-92" href="#__codelineno-16-92"></a><span class="p">{</span>  
</span><span id="__span-16-93"><a id="__codelineno-16-93" name="__codelineno-16-93" href="#__codelineno-16-93"></a>    <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span> <span class="nv">$resourceGroupName</span> <span class="s2">&quot;- Terraform Management Resource Group already exists.&quot;</span>  
</span><span id="__span-16-94"><a id="__codelineno-16-94" name="__codelineno-16-94" href="#__codelineno-16-94"></a><span class="p">}</span>  
</span><span id="__span-16-95"><a id="__codelineno-16-95" name="__codelineno-16-95" href="#__codelineno-16-95"></a><span class="k">else</span>  
</span><span id="__span-16-96"><a id="__codelineno-16-96" name="__codelineno-16-96" href="#__codelineno-16-96"></a><span class="p">{</span>  
</span><span id="__span-16-97"><a id="__codelineno-16-97" name="__codelineno-16-97" href="#__codelineno-16-97"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Creating Terraform Management Resource Group: [$resourceGroupName]...&quot;</span>
</span><span id="__span-16-98"><a id="__codelineno-16-98" name="__codelineno-16-98" href="#__codelineno-16-98"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-16-99"><a id="__codelineno-16-99" name="__codelineno-16-99" href="#__codelineno-16-99"></a>        <span class="nv">$azResourceGroupParams</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-16-100"><a id="__codelineno-16-100" name="__codelineno-16-100" href="#__codelineno-16-100"></a>            <span class="n">Name</span>        <span class="p">=</span> <span class="nv">$resourceGroupName</span>
</span><span id="__span-16-101"><a id="__codelineno-16-101" name="__codelineno-16-101" href="#__codelineno-16-101"></a>            <span class="n">Location</span>    <span class="p">=</span> <span class="nv">$location</span>
</span><span id="__span-16-102"><a id="__codelineno-16-102" name="__codelineno-16-102" href="#__codelineno-16-102"></a>            <span class="n">Tag</span>         <span class="p">=</span> <span class="p">@{</span> <span class="n">keep</span> <span class="p">=</span> <span class="s2">&quot;true&quot;</span> <span class="p">}</span>
</span><span id="__span-16-103"><a id="__codelineno-16-103" name="__codelineno-16-103" href="#__codelineno-16-103"></a>            <span class="n">Force</span>       <span class="p">=</span> <span class="nv">$true</span>
</span><span id="__span-16-104"><a id="__codelineno-16-104" name="__codelineno-16-104" href="#__codelineno-16-104"></a>            <span class="n">ErrorAction</span> <span class="p">=</span> <span class="s1">&#39;Stop&#39;</span>
</span><span id="__span-16-105"><a id="__codelineno-16-105" name="__codelineno-16-105" href="#__codelineno-16-105"></a>            <span class="n">Verbose</span>     <span class="p">=</span> <span class="nv">$VerbosePreference</span>
</span><span id="__span-16-106"><a id="__codelineno-16-106" name="__codelineno-16-106" href="#__codelineno-16-106"></a>        <span class="p">}</span>
</span><span id="__span-16-107"><a id="__codelineno-16-107" name="__codelineno-16-107" href="#__codelineno-16-107"></a>        <span class="nb">New-AzResourceGroup</span> <span class="nv">@azResourceGroupParams</span> <span class="p">|</span> <span class="nb">Out-String</span> <span class="p">|</span> <span class="nb">Write-Verbose</span>
</span><span id="__span-16-108"><a id="__codelineno-16-108" name="__codelineno-16-108" href="#__codelineno-16-108"></a>    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-16-109"><a id="__codelineno-16-109" name="__codelineno-16-109" href="#__codelineno-16-109"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;ERROR!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Red&#39;</span>
</span><span id="__span-16-110"><a id="__codelineno-16-110" name="__codelineno-16-110" href="#__codelineno-16-110"></a>        <span class="k">throw</span> <span class="nv">$_</span>
</span><span id="__span-16-111"><a id="__codelineno-16-111" name="__codelineno-16-111" href="#__codelineno-16-111"></a>    <span class="p">}</span>
</span><span id="__span-16-112"><a id="__codelineno-16-112" name="__codelineno-16-112" href="#__codelineno-16-112"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;SUCCESS!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>
</span><span id="__span-16-113"><a id="__codelineno-16-113" name="__codelineno-16-113" href="#__codelineno-16-113"></a><span class="p">}</span>
</span><span id="__span-16-114"><a id="__codelineno-16-114" name="__codelineno-16-114" href="#__codelineno-16-114"></a>
</span><span id="__span-16-115"><a id="__codelineno-16-115" name="__codelineno-16-115" href="#__codelineno-16-115"></a>
</span><span id="__span-16-116"><a id="__codelineno-16-116" name="__codelineno-16-116" href="#__codelineno-16-116"></a><span class="c"># New storage account</span>
</span><span id="__span-16-117"><a id="__codelineno-16-117" name="__codelineno-16-117" href="#__codelineno-16-117"></a> <span class="k">if</span><span class="p">(</span><span class="nb">Get-AzStorageAccount</span> <span class="n">-ResourceGroupName</span> <span class="nv">$resourceGroupName</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span><span class="p">)</span>  
</span><span id="__span-16-118"><a id="__codelineno-16-118" name="__codelineno-16-118" href="#__codelineno-16-118"></a> <span class="p">{</span>  
</span><span id="__span-16-119"><a id="__codelineno-16-119" name="__codelineno-16-119" href="#__codelineno-16-119"></a>      <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span> <span class="nv">$storageAccountName</span> <span class="s2">&quot;- Storage Account for terraform states already exists.&quot;</span>     
</span><span id="__span-16-120"><a id="__codelineno-16-120" name="__codelineno-16-120" href="#__codelineno-16-120"></a> <span class="p">}</span>  
</span><span id="__span-16-121"><a id="__codelineno-16-121" name="__codelineno-16-121" href="#__codelineno-16-121"></a> <span class="k">else</span>  
</span><span id="__span-16-122"><a id="__codelineno-16-122" name="__codelineno-16-122" href="#__codelineno-16-122"></a> <span class="p">{</span>  
</span><span id="__span-16-123"><a id="__codelineno-16-123" name="__codelineno-16-123" href="#__codelineno-16-123"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Creating Storage Account for terraform states: [$storageAccountName]...&quot;</span>
</span><span id="__span-16-124"><a id="__codelineno-16-124" name="__codelineno-16-124" href="#__codelineno-16-124"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-16-125"><a id="__codelineno-16-125" name="__codelineno-16-125" href="#__codelineno-16-125"></a>        <span class="nv">$azStorageAccountParams</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-16-126"><a id="__codelineno-16-126" name="__codelineno-16-126" href="#__codelineno-16-126"></a>            <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="nv">$resourceGroupName</span>
</span><span id="__span-16-127"><a id="__codelineno-16-127" name="__codelineno-16-127" href="#__codelineno-16-127"></a>            <span class="n">Location</span>          <span class="p">=</span> <span class="nv">$location</span>
</span><span id="__span-16-128"><a id="__codelineno-16-128" name="__codelineno-16-128" href="#__codelineno-16-128"></a>            <span class="n">Name</span>              <span class="p">=</span> <span class="nv">$storageAccountName</span>
</span><span id="__span-16-129"><a id="__codelineno-16-129" name="__codelineno-16-129" href="#__codelineno-16-129"></a>            <span class="n">SkuName</span>           <span class="p">=</span> <span class="nv">$storageAccountSku</span>
</span><span id="__span-16-130"><a id="__codelineno-16-130" name="__codelineno-16-130" href="#__codelineno-16-130"></a>            <span class="n">Kind</span>              <span class="p">=</span> <span class="s1">&#39;StorageV2&#39;</span>
</span><span id="__span-16-131"><a id="__codelineno-16-131" name="__codelineno-16-131" href="#__codelineno-16-131"></a>            <span class="n">ErrorAction</span>       <span class="p">=</span> <span class="s1">&#39;Stop&#39;</span>
</span><span id="__span-16-132"><a id="__codelineno-16-132" name="__codelineno-16-132" href="#__codelineno-16-132"></a>            <span class="n">Verbose</span>           <span class="p">=</span> <span class="nv">$VerbosePreference</span>
</span><span id="__span-16-133"><a id="__codelineno-16-133" name="__codelineno-16-133" href="#__codelineno-16-133"></a>        <span class="p">}</span>
</span><span id="__span-16-134"><a id="__codelineno-16-134" name="__codelineno-16-134" href="#__codelineno-16-134"></a>        <span class="nb">New-AzStorageAccount</span> <span class="nv">@azStorageAccountParams</span> <span class="p">|</span> <span class="nb">Out-String</span> <span class="p">|</span> <span class="nb">Write-Verbose</span>
</span><span id="__span-16-135"><a id="__codelineno-16-135" name="__codelineno-16-135" href="#__codelineno-16-135"></a>    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-16-136"><a id="__codelineno-16-136" name="__codelineno-16-136" href="#__codelineno-16-136"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;ERROR!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Red&#39;</span>
</span><span id="__span-16-137"><a id="__codelineno-16-137" name="__codelineno-16-137" href="#__codelineno-16-137"></a>        <span class="k">throw</span> <span class="nv">$_</span>
</span><span id="__span-16-138"><a id="__codelineno-16-138" name="__codelineno-16-138" href="#__codelineno-16-138"></a>    <span class="p">}</span>
</span><span id="__span-16-139"><a id="__codelineno-16-139" name="__codelineno-16-139" href="#__codelineno-16-139"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;SUCCESS!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>    
</span><span id="__span-16-140"><a id="__codelineno-16-140" name="__codelineno-16-140" href="#__codelineno-16-140"></a><span class="p">}</span>
</span><span id="__span-16-141"><a id="__codelineno-16-141" name="__codelineno-16-141" href="#__codelineno-16-141"></a>
</span><span id="__span-16-142"><a id="__codelineno-16-142" name="__codelineno-16-142" href="#__codelineno-16-142"></a><span class="c"># Select Storage Container</span>
</span><span id="__span-16-143"><a id="__codelineno-16-143" name="__codelineno-16-143" href="#__codelineno-16-143"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Selecting Default Storage Account...&quot;</span>
</span><span id="__span-16-144"><a id="__codelineno-16-144" name="__codelineno-16-144" href="#__codelineno-16-144"></a><span class="k">try</span> <span class="p">{</span>
</span><span id="__span-16-145"><a id="__codelineno-16-145" name="__codelineno-16-145" href="#__codelineno-16-145"></a>    <span class="nv">$azCurrentStorageAccountParams</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-16-146"><a id="__codelineno-16-146" name="__codelineno-16-146" href="#__codelineno-16-146"></a>        <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="nv">$resourceGroupName</span>
</span><span id="__span-16-147"><a id="__codelineno-16-147" name="__codelineno-16-147" href="#__codelineno-16-147"></a>        <span class="n">AccountName</span>       <span class="p">=</span> <span class="nv">$storageAccountName</span>
</span><span id="__span-16-148"><a id="__codelineno-16-148" name="__codelineno-16-148" href="#__codelineno-16-148"></a>        <span class="n">ErrorAction</span>       <span class="p">=</span> <span class="s1">&#39;Stop&#39;</span>
</span><span id="__span-16-149"><a id="__codelineno-16-149" name="__codelineno-16-149" href="#__codelineno-16-149"></a>        <span class="n">Verbose</span>           <span class="p">=</span> <span class="nv">$VerbosePreference</span>
</span><span id="__span-16-150"><a id="__codelineno-16-150" name="__codelineno-16-150" href="#__codelineno-16-150"></a>    <span class="p">}</span>
</span><span id="__span-16-151"><a id="__codelineno-16-151" name="__codelineno-16-151" href="#__codelineno-16-151"></a>    <span class="nb">Set-AzCurrentStorageAccount</span> <span class="nv">@azCurrentStorageAccountParams</span> <span class="p">|</span> <span class="nb">Out-String</span> <span class="p">|</span> <span class="nb">Write-Verbose</span>
</span><span id="__span-16-152"><a id="__codelineno-16-152" name="__codelineno-16-152" href="#__codelineno-16-152"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-16-153"><a id="__codelineno-16-153" name="__codelineno-16-153" href="#__codelineno-16-153"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;ERROR!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Red&#39;</span>
</span><span id="__span-16-154"><a id="__codelineno-16-154" name="__codelineno-16-154" href="#__codelineno-16-154"></a>    <span class="k">throw</span> <span class="nv">$_</span>
</span><span id="__span-16-155"><a id="__codelineno-16-155" name="__codelineno-16-155" href="#__codelineno-16-155"></a><span class="p">}</span>
</span><span id="__span-16-156"><a id="__codelineno-16-156" name="__codelineno-16-156" href="#__codelineno-16-156"></a><span class="nb">Write-Host</span> <span class="s2">&quot;SUCCESS!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>
</span><span id="__span-16-157"><a id="__codelineno-16-157" name="__codelineno-16-157" href="#__codelineno-16-157"></a>
</span><span id="__span-16-158"><a id="__codelineno-16-158" name="__codelineno-16-158" href="#__codelineno-16-158"></a>
</span><span id="__span-16-159"><a id="__codelineno-16-159" name="__codelineno-16-159" href="#__codelineno-16-159"></a><span class="c"># # New Storage Container</span>
</span><span id="__span-16-160"><a id="__codelineno-16-160" name="__codelineno-16-160" href="#__codelineno-16-160"></a><span class="c"># if(Get-AzStorageContainer -Name $storageContainerName -ErrorAction SilentlyContinue)  </span>
</span><span id="__span-16-161"><a id="__codelineno-16-161" name="__codelineno-16-161" href="#__codelineno-16-161"></a><span class="c"># {  </span>
</span><span id="__span-16-162"><a id="__codelineno-16-162" name="__codelineno-16-162" href="#__codelineno-16-162"></a><span class="c">#     Write-Host -ForegroundColor Magenta $storageContainerName &quot;- Storage Container already exists.&quot;  </span>
</span><span id="__span-16-163"><a id="__codelineno-16-163" name="__codelineno-16-163" href="#__codelineno-16-163"></a><span class="c"># }  </span>
</span><span id="__span-16-164"><a id="__codelineno-16-164" name="__codelineno-16-164" href="#__codelineno-16-164"></a><span class="c"># else  </span>
</span><span id="__span-16-165"><a id="__codelineno-16-165" name="__codelineno-16-165" href="#__codelineno-16-165"></a><span class="c"># {</span>
</span><span id="__span-16-166"><a id="__codelineno-16-166" name="__codelineno-16-166" href="#__codelineno-16-166"></a><span class="c">#     Write-Host &quot;`nCreating Storage Container: [$storageContainerName]...&quot;</span>
</span><span id="__span-16-167"><a id="__codelineno-16-167" name="__codelineno-16-167" href="#__codelineno-16-167"></a><span class="c">#     try {</span>
</span><span id="__span-16-168"><a id="__codelineno-16-168" name="__codelineno-16-168" href="#__codelineno-16-168"></a><span class="c">#         $azStorageContainerParams = @{</span>
</span><span id="__span-16-169"><a id="__codelineno-16-169" name="__codelineno-16-169" href="#__codelineno-16-169"></a><span class="c">#             Name        = $storageContainerName</span>
</span><span id="__span-16-170"><a id="__codelineno-16-170" name="__codelineno-16-170" href="#__codelineno-16-170"></a><span class="c">#             Permission  = &#39;Off&#39;</span>
</span><span id="__span-16-171"><a id="__codelineno-16-171" name="__codelineno-16-171" href="#__codelineno-16-171"></a><span class="c">#             # ErrorAction = &#39;Stop&#39;</span>
</span><span id="__span-16-172"><a id="__codelineno-16-172" name="__codelineno-16-172" href="#__codelineno-16-172"></a><span class="c">#             Verbose     = $VerbosePreference</span>
</span><span id="__span-16-173"><a id="__codelineno-16-173" name="__codelineno-16-173" href="#__codelineno-16-173"></a><span class="c">#         }</span>
</span><span id="__span-16-174"><a id="__codelineno-16-174" name="__codelineno-16-174" href="#__codelineno-16-174"></a>
</span><span id="__span-16-175"><a id="__codelineno-16-175" name="__codelineno-16-175" href="#__codelineno-16-175"></a><span class="c">#         $storageAccountKey = (Get-AzStorageAccountKey -ResourceGroupName $resourceGroupName -Name $storageAccountName)[0].Value</span>
</span><span id="__span-16-176"><a id="__codelineno-16-176" name="__codelineno-16-176" href="#__codelineno-16-176"></a><span class="c">#         $storageContext = New-AzureStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey</span>
</span><span id="__span-16-177"><a id="__codelineno-16-177" name="__codelineno-16-177" href="#__codelineno-16-177"></a>
</span><span id="__span-16-178"><a id="__codelineno-16-178" name="__codelineno-16-178" href="#__codelineno-16-178"></a><span class="c">#         New-AzStorageContainer @azStorageContainerParams -Context $storageContext | Out-String | Write-Verbose</span>
</span><span id="__span-16-179"><a id="__codelineno-16-179" name="__codelineno-16-179" href="#__codelineno-16-179"></a><span class="c">#     } catch {</span>
</span><span id="__span-16-180"><a id="__codelineno-16-180" name="__codelineno-16-180" href="#__codelineno-16-180"></a><span class="c">#         Write-Host &quot;ERROR!&quot; -ForegroundColor &#39;Red&#39;</span>
</span><span id="__span-16-181"><a id="__codelineno-16-181" name="__codelineno-16-181" href="#__codelineno-16-181"></a><span class="c">#         throw $_</span>
</span><span id="__span-16-182"><a id="__codelineno-16-182" name="__codelineno-16-182" href="#__codelineno-16-182"></a><span class="c">#     }</span>
</span><span id="__span-16-183"><a id="__codelineno-16-183" name="__codelineno-16-183" href="#__codelineno-16-183"></a><span class="c">#     Write-Host &quot;SUCCESS!&quot; -ForegroundColor &#39;Green&#39;</span>
</span><span id="__span-16-184"><a id="__codelineno-16-184" name="__codelineno-16-184" href="#__codelineno-16-184"></a><span class="c"># }</span>
</span><span id="__span-16-185"><a id="__codelineno-16-185" name="__codelineno-16-185" href="#__codelineno-16-185"></a>
</span><span id="__span-16-186"><a id="__codelineno-16-186" name="__codelineno-16-186" href="#__codelineno-16-186"></a><span class="c"># New KeyVault</span>
</span><span id="__span-16-187"><a id="__codelineno-16-187" name="__codelineno-16-187" href="#__codelineno-16-187"></a>
</span><span id="__span-16-188"><a id="__codelineno-16-188" name="__codelineno-16-188" href="#__codelineno-16-188"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Creating Key Vault for terraform secrets: [$vaultName]...&quot;</span>
</span><span id="__span-16-189"><a id="__codelineno-16-189" name="__codelineno-16-189" href="#__codelineno-16-189"></a><span class="k">if</span><span class="p">(</span><span class="nb">Get-AzKeyVault</span> <span class="n">-Name</span> <span class="nv">$vaultName</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span><span class="p">)</span>  
</span><span id="__span-16-190"><a id="__codelineno-16-190" name="__codelineno-16-190" href="#__codelineno-16-190"></a><span class="p">{</span>  
</span><span id="__span-16-191"><a id="__codelineno-16-191" name="__codelineno-16-191" href="#__codelineno-16-191"></a>     <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="n">Magenta</span> <span class="nv">$vaultName</span> <span class="s2">&quot;- Key Vault already exists.&quot;</span>  
</span><span id="__span-16-192"><a id="__codelineno-16-192" name="__codelineno-16-192" href="#__codelineno-16-192"></a><span class="p">}</span>  
</span><span id="__span-16-193"><a id="__codelineno-16-193" name="__codelineno-16-193" href="#__codelineno-16-193"></a><span class="k">else</span>  
</span><span id="__span-16-194"><a id="__codelineno-16-194" name="__codelineno-16-194" href="#__codelineno-16-194"></a><span class="p">{</span>
</span><span id="__span-16-195"><a id="__codelineno-16-195" name="__codelineno-16-195" href="#__codelineno-16-195"></a>    <span class="k">try</span> <span class="p">{</span>
</span><span id="__span-16-196"><a id="__codelineno-16-196" name="__codelineno-16-196" href="#__codelineno-16-196"></a>
</span><span id="__span-16-197"><a id="__codelineno-16-197" name="__codelineno-16-197" href="#__codelineno-16-197"></a>        <span class="nb">Register-AzResourceProvider</span> <span class="n">-ProviderNamespace</span> <span class="s2">&quot;Microsoft.KeyVault&quot;</span>
</span><span id="__span-16-198"><a id="__codelineno-16-198" name="__codelineno-16-198" href="#__codelineno-16-198"></a>        <span class="nv">$azKeyVaultParams</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-16-199"><a id="__codelineno-16-199" name="__codelineno-16-199" href="#__codelineno-16-199"></a>            <span class="n">VaultName</span>         <span class="p">=</span> <span class="nv">$vaultName</span>
</span><span id="__span-16-200"><a id="__codelineno-16-200" name="__codelineno-16-200" href="#__codelineno-16-200"></a>            <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="nv">$resourceGroupName</span>
</span><span id="__span-16-201"><a id="__codelineno-16-201" name="__codelineno-16-201" href="#__codelineno-16-201"></a>            <span class="n">Location</span>          <span class="p">=</span> <span class="nv">$location</span>
</span><span id="__span-16-202"><a id="__codelineno-16-202" name="__codelineno-16-202" href="#__codelineno-16-202"></a>            <span class="n">ErrorAction</span>       <span class="p">=</span> <span class="s1">&#39;Stop&#39;</span>
</span><span id="__span-16-203"><a id="__codelineno-16-203" name="__codelineno-16-203" href="#__codelineno-16-203"></a>            <span class="n">Verbose</span>           <span class="p">=</span> <span class="nv">$VerbosePreference</span>
</span><span id="__span-16-204"><a id="__codelineno-16-204" name="__codelineno-16-204" href="#__codelineno-16-204"></a>        <span class="p">}</span>
</span><span id="__span-16-205"><a id="__codelineno-16-205" name="__codelineno-16-205" href="#__codelineno-16-205"></a>        <span class="nb">New-AzKeyVault</span> <span class="nv">@azKeyVaultParams</span> <span class="p">|</span> <span class="nb">Out-String</span> <span class="p">|</span> <span class="nb">Write-Verbose</span>
</span><span id="__span-16-206"><a id="__codelineno-16-206" name="__codelineno-16-206" href="#__codelineno-16-206"></a>    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-16-207"><a id="__codelineno-16-207" name="__codelineno-16-207" href="#__codelineno-16-207"></a>        <span class="nb">Write-Host</span> <span class="s2">&quot;ERROR!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Red&#39;</span>
</span><span id="__span-16-208"><a id="__codelineno-16-208" name="__codelineno-16-208" href="#__codelineno-16-208"></a>        <span class="k">throw</span> <span class="nv">$_</span>
</span><span id="__span-16-209"><a id="__codelineno-16-209" name="__codelineno-16-209" href="#__codelineno-16-209"></a>    <span class="p">}</span>
</span><span id="__span-16-210"><a id="__codelineno-16-210" name="__codelineno-16-210" href="#__codelineno-16-210"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;SUCCESS!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>
</span><span id="__span-16-211"><a id="__codelineno-16-211" name="__codelineno-16-211" href="#__codelineno-16-211"></a><span class="p">}</span>
</span><span id="__span-16-212"><a id="__codelineno-16-212" name="__codelineno-16-212" href="#__codelineno-16-212"></a>
</span><span id="__span-16-213"><a id="__codelineno-16-213" name="__codelineno-16-213" href="#__codelineno-16-213"></a><span class="c"># Set KeyVault Access Policy</span>
</span><span id="__span-16-214"><a id="__codelineno-16-214" name="__codelineno-16-214" href="#__codelineno-16-214"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Setting KeyVault Access Policy for Admin User: [$adminUserDisplayName]...&quot;</span>
</span><span id="__span-16-215"><a id="__codelineno-16-215" name="__codelineno-16-215" href="#__codelineno-16-215"></a><span class="nv">$adminADUser</span> <span class="p">=</span> <span class="nb">Get-AzADUser</span> <span class="n">-DisplayName</span> <span class="nv">$adminUserDisplayName</span>
</span><span id="__span-16-216"><a id="__codelineno-16-216" name="__codelineno-16-216" href="#__codelineno-16-216"></a><span class="nb">Write-Host</span> <span class="s2">&quot;adminADUser = ${adminADUser}&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>
</span><span id="__span-16-217"><a id="__codelineno-16-217" name="__codelineno-16-217" href="#__codelineno-16-217"></a><span class="k">try</span> <span class="p">{</span>
</span><span id="__span-16-218"><a id="__codelineno-16-218" name="__codelineno-16-218" href="#__codelineno-16-218"></a>    <span class="nv">$azKeyVaultAccessPolicyParams</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-16-219"><a id="__codelineno-16-219" name="__codelineno-16-219" href="#__codelineno-16-219"></a>        <span class="n">VaultName</span>                 <span class="p">=</span> <span class="nv">$vaultName</span>
</span><span id="__span-16-220"><a id="__codelineno-16-220" name="__codelineno-16-220" href="#__codelineno-16-220"></a>        <span class="n">ResourceGroupName</span>         <span class="p">=</span> <span class="nv">$resourceGroupName</span>
</span><span id="__span-16-221"><a id="__codelineno-16-221" name="__codelineno-16-221" href="#__codelineno-16-221"></a>        <span class="n">UserPrincipalName</span>         <span class="p">=</span> <span class="nv">$adminUserDisplayName</span>
</span><span id="__span-16-222"><a id="__codelineno-16-222" name="__codelineno-16-222" href="#__codelineno-16-222"></a>        <span class="n">PermissionsToKeys</span>         <span class="p">=</span> <span class="p">@(</span><span class="s1">&#39;Get&#39;</span><span class="p">,</span> <span class="s1">&#39;List&#39;</span><span class="p">)</span>
</span><span id="__span-16-223"><a id="__codelineno-16-223" name="__codelineno-16-223" href="#__codelineno-16-223"></a>        <span class="n">PermissionsToSecrets</span>      <span class="p">=</span> <span class="p">@(</span><span class="s1">&#39;Get&#39;</span><span class="p">,</span> <span class="s1">&#39;List&#39;</span><span class="p">,</span> <span class="s1">&#39;Set&#39;</span><span class="p">)</span>
</span><span id="__span-16-224"><a id="__codelineno-16-224" name="__codelineno-16-224" href="#__codelineno-16-224"></a>        <span class="n">PermissionsToCertificates</span> <span class="p">=</span> <span class="p">@(</span><span class="s1">&#39;Get&#39;</span><span class="p">,</span> <span class="s1">&#39;List&#39;</span><span class="p">)</span>
</span><span id="__span-16-225"><a id="__codelineno-16-225" name="__codelineno-16-225" href="#__codelineno-16-225"></a>        <span class="n">ErrorAction</span>               <span class="p">=</span> <span class="s1">&#39;Stop&#39;</span>
</span><span id="__span-16-226"><a id="__codelineno-16-226" name="__codelineno-16-226" href="#__codelineno-16-226"></a>        <span class="n">Verbose</span>                   <span class="p">=</span> <span class="nv">$VerbosePreference</span>
</span><span id="__span-16-227"><a id="__codelineno-16-227" name="__codelineno-16-227" href="#__codelineno-16-227"></a>    <span class="p">}</span>
</span><span id="__span-16-228"><a id="__codelineno-16-228" name="__codelineno-16-228" href="#__codelineno-16-228"></a>    <span class="nb">Set-AzKeyVaultAccessPolicy</span> <span class="nv">@azKeyVaultAccessPolicyParams</span> <span class="n">-PassThru</span> <span class="p">|</span> <span class="nb">Out-String</span> <span class="p">|</span> <span class="nb">Write-Verbose</span>
</span><span id="__span-16-229"><a id="__codelineno-16-229" name="__codelineno-16-229" href="#__codelineno-16-229"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-16-230"><a id="__codelineno-16-230" name="__codelineno-16-230" href="#__codelineno-16-230"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;ERROR!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Red&#39;</span>
</span><span id="__span-16-231"><a id="__codelineno-16-231" name="__codelineno-16-231" href="#__codelineno-16-231"></a>    <span class="k">throw</span> <span class="nv">$_</span>
</span><span id="__span-16-232"><a id="__codelineno-16-232" name="__codelineno-16-232" href="#__codelineno-16-232"></a><span class="p">}</span>
</span><span id="__span-16-233"><a id="__codelineno-16-233" name="__codelineno-16-233" href="#__codelineno-16-233"></a><span class="nb">Write-Host</span> <span class="s2">&quot;SUCCESS!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>
</span><span id="__span-16-234"><a id="__codelineno-16-234" name="__codelineno-16-234" href="#__codelineno-16-234"></a>
</span><span id="__span-16-235"><a id="__codelineno-16-235" name="__codelineno-16-235" href="#__codelineno-16-235"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Setting KeyVault Access Policy for Terraform SP: [$servicePrincipalName]...&quot;</span>
</span><span id="__span-16-236"><a id="__codelineno-16-236" name="__codelineno-16-236" href="#__codelineno-16-236"></a><span class="k">try</span> <span class="p">{</span>
</span><span id="__span-16-237"><a id="__codelineno-16-237" name="__codelineno-16-237" href="#__codelineno-16-237"></a>    <span class="nv">$azKeyVaultAccessPolicyParams</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-16-238"><a id="__codelineno-16-238" name="__codelineno-16-238" href="#__codelineno-16-238"></a>        <span class="n">VaultName</span>                 <span class="p">=</span> <span class="nv">$vaultName</span>
</span><span id="__span-16-239"><a id="__codelineno-16-239" name="__codelineno-16-239" href="#__codelineno-16-239"></a>        <span class="n">ResourceGroupName</span>         <span class="p">=</span> <span class="nv">$resourceGroupName</span>
</span><span id="__span-16-240"><a id="__codelineno-16-240" name="__codelineno-16-240" href="#__codelineno-16-240"></a>        <span class="n">ObjectId</span>                  <span class="p">=</span> <span class="nv">$terraformSP</span><span class="p">.</span><span class="n">Id</span>
</span><span id="__span-16-241"><a id="__codelineno-16-241" name="__codelineno-16-241" href="#__codelineno-16-241"></a>        <span class="n">PermissionsToKeys</span>         <span class="p">=</span> <span class="p">@(</span><span class="s1">&#39;Get&#39;</span><span class="p">,</span> <span class="s1">&#39;List&#39;</span><span class="p">)</span>
</span><span id="__span-16-242"><a id="__codelineno-16-242" name="__codelineno-16-242" href="#__codelineno-16-242"></a>        <span class="n">PermissionsToSecrets</span>      <span class="p">=</span> <span class="p">@(</span><span class="s1">&#39;Get&#39;</span><span class="p">,</span> <span class="s1">&#39;List&#39;</span><span class="p">,</span> <span class="s1">&#39;Set&#39;</span><span class="p">)</span>
</span><span id="__span-16-243"><a id="__codelineno-16-243" name="__codelineno-16-243" href="#__codelineno-16-243"></a>        <span class="n">PermissionsToCertificates</span> <span class="p">=</span> <span class="p">@(</span><span class="s1">&#39;Get&#39;</span><span class="p">,</span> <span class="s1">&#39;List&#39;</span><span class="p">)</span>
</span><span id="__span-16-244"><a id="__codelineno-16-244" name="__codelineno-16-244" href="#__codelineno-16-244"></a>        <span class="n">ErrorAction</span>               <span class="p">=</span> <span class="s1">&#39;Stop&#39;</span>
</span><span id="__span-16-245"><a id="__codelineno-16-245" name="__codelineno-16-245" href="#__codelineno-16-245"></a>        <span class="n">Verbose</span>                   <span class="p">=</span> <span class="nv">$VerbosePreference</span>
</span><span id="__span-16-246"><a id="__codelineno-16-246" name="__codelineno-16-246" href="#__codelineno-16-246"></a>    <span class="p">}</span>
</span><span id="__span-16-247"><a id="__codelineno-16-247" name="__codelineno-16-247" href="#__codelineno-16-247"></a>    <span class="nb">Set-AzKeyVaultAccessPolicy</span> <span class="nv">@azKeyVaultAccessPolicyParams</span> <span class="p">|</span> <span class="nb">Out-String</span> <span class="p">|</span> <span class="nb">Write-Verbose</span>
</span><span id="__span-16-248"><a id="__codelineno-16-248" name="__codelineno-16-248" href="#__codelineno-16-248"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-16-249"><a id="__codelineno-16-249" name="__codelineno-16-249" href="#__codelineno-16-249"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;ERROR!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Red&#39;</span>
</span><span id="__span-16-250"><a id="__codelineno-16-250" name="__codelineno-16-250" href="#__codelineno-16-250"></a>    <span class="k">throw</span> <span class="nv">$_</span>
</span><span id="__span-16-251"><a id="__codelineno-16-251" name="__codelineno-16-251" href="#__codelineno-16-251"></a><span class="p">}</span>
</span><span id="__span-16-252"><a id="__codelineno-16-252" name="__codelineno-16-252" href="#__codelineno-16-252"></a><span class="nb">Write-Host</span> <span class="s2">&quot;SUCCESS!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>
</span><span id="__span-16-253"><a id="__codelineno-16-253" name="__codelineno-16-253" href="#__codelineno-16-253"></a>
</span><span id="__span-16-254"><a id="__codelineno-16-254" name="__codelineno-16-254" href="#__codelineno-16-254"></a>
</span><span id="__span-16-255"><a id="__codelineno-16-255" name="__codelineno-16-255" href="#__codelineno-16-255"></a><span class="c"># Terraform login variables</span>
</span><span id="__span-16-256"><a id="__codelineno-16-256" name="__codelineno-16-256" href="#__codelineno-16-256"></a><span class="c"># Get Storage Access Key</span>
</span><span id="__span-16-257"><a id="__codelineno-16-257" name="__codelineno-16-257" href="#__codelineno-16-257"></a><span class="nv">$storageAccessKeys</span> <span class="p">=</span> <span class="nb">Get-AzStorageAccountKey</span> <span class="n">-ResourceGroupName</span> <span class="nv">$resourceGroupName</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span>
</span><span id="__span-16-258"><a id="__codelineno-16-258" name="__codelineno-16-258" href="#__codelineno-16-258"></a><span class="nv">$storageAccessKey</span> <span class="p">=</span> <span class="nv">$storageAccessKeys</span><span class="p">[</span><span class="n">0</span><span class="p">].</span><span class="n">Value</span> <span class="c"># only need one of the keys</span>
</span><span id="__span-16-259"><a id="__codelineno-16-259" name="__codelineno-16-259" href="#__codelineno-16-259"></a>
</span><span id="__span-16-260"><a id="__codelineno-16-260" name="__codelineno-16-260" href="#__codelineno-16-260"></a><span class="nv">$terraformLoginVars</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-16-261"><a id="__codelineno-16-261" name="__codelineno-16-261" href="#__codelineno-16-261"></a>    <span class="s1">&#39;tf-subscription-id&#39;</span> <span class="p">=</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">Id</span>
</span><span id="__span-16-262"><a id="__codelineno-16-262" name="__codelineno-16-262" href="#__codelineno-16-262"></a>    <span class="s1">&#39;tf-client-id&#39;</span>       <span class="p">=</span> <span class="nv">$terraformSP</span><span class="p">.</span><span class="n">appId</span>
</span><span id="__span-16-263"><a id="__codelineno-16-263" name="__codelineno-16-263" href="#__codelineno-16-263"></a>    <span class="s1">&#39;tf-client-secret&#39;</span>   <span class="p">=</span> <span class="nv">$servicePrinciplePassword</span>
</span><span id="__span-16-264"><a id="__codelineno-16-264" name="__codelineno-16-264" href="#__codelineno-16-264"></a>    <span class="s1">&#39;tf-tenant-id&#39;</span>       <span class="p">=</span> <span class="nv">$subscription</span><span class="p">.</span><span class="n">TenantId</span>
</span><span id="__span-16-265"><a id="__codelineno-16-265" name="__codelineno-16-265" href="#__codelineno-16-265"></a>    <span class="s1">&#39;tf-access-key&#39;</span>      <span class="p">=</span> <span class="nv">$storageAccessKey</span>
</span><span id="__span-16-266"><a id="__codelineno-16-266" name="__codelineno-16-266" href="#__codelineno-16-266"></a><span class="p">}</span>
</span><span id="__span-16-267"><a id="__codelineno-16-267" name="__codelineno-16-267" href="#__codelineno-16-267"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Terraform login details:&quot;</span>
</span><span id="__span-16-268"><a id="__codelineno-16-268" name="__codelineno-16-268" href="#__codelineno-16-268"></a><span class="nv">$terraformLoginVars</span> <span class="p">|</span> <span class="nb">Out-String</span> <span class="p">|</span> <span class="nb">Write-Host</span>
</span><span id="__span-16-269"><a id="__codelineno-16-269" name="__codelineno-16-269" href="#__codelineno-16-269"></a>
</span><span id="__span-16-270"><a id="__codelineno-16-270" name="__codelineno-16-270" href="#__codelineno-16-270"></a><span class="c"># Create KeyVault Secrets</span>
</span><span id="__span-16-271"><a id="__codelineno-16-271" name="__codelineno-16-271" href="#__codelineno-16-271"></a><span class="nb">Write-Host</span> <span class="s2">&quot;</span><span class="se">`n</span><span class="s2">Creating KeyVault Secrets for Terraform...&quot;</span>
</span><span id="__span-16-272"><a id="__codelineno-16-272" name="__codelineno-16-272" href="#__codelineno-16-272"></a><span class="k">try</span> <span class="p">{</span>
</span><span id="__span-16-273"><a id="__codelineno-16-273" name="__codelineno-16-273" href="#__codelineno-16-273"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$terraformLoginVar</span> <span class="k">in</span> <span class="nv">$terraformLoginVars</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">())</span> <span class="p">{</span>
</span><span id="__span-16-274"><a id="__codelineno-16-274" name="__codelineno-16-274" href="#__codelineno-16-274"></a>        <span class="nv">$AzKeyVaultSecretParams</span> <span class="p">=</span> <span class="p">@{</span>
</span><span id="__span-16-275"><a id="__codelineno-16-275" name="__codelineno-16-275" href="#__codelineno-16-275"></a>            <span class="n">VaultName</span>   <span class="p">=</span> <span class="nv">$vaultName</span>
</span><span id="__span-16-276"><a id="__codelineno-16-276" name="__codelineno-16-276" href="#__codelineno-16-276"></a>            <span class="n">Name</span>        <span class="p">=</span> <span class="nv">$terraformLoginVar</span><span class="p">.</span><span class="n">Key</span>
</span><span id="__span-16-277"><a id="__codelineno-16-277" name="__codelineno-16-277" href="#__codelineno-16-277"></a>            <span class="n">SecretValue</span> <span class="p">=</span> <span class="p">(</span><span class="nb">ConvertTo-SecureString</span> <span class="n">-String</span> <span class="nv">$terraformLoginVar</span><span class="p">.</span><span class="n">Value</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">)</span>
</span><span id="__span-16-278"><a id="__codelineno-16-278" name="__codelineno-16-278" href="#__codelineno-16-278"></a>            <span class="n">ErrorAction</span> <span class="p">=</span> <span class="s1">&#39;Stop&#39;</span>
</span><span id="__span-16-279"><a id="__codelineno-16-279" name="__codelineno-16-279" href="#__codelineno-16-279"></a>            <span class="n">Verbose</span>     <span class="p">=</span> <span class="nv">$VerbosePreference</span>
</span><span id="__span-16-280"><a id="__codelineno-16-280" name="__codelineno-16-280" href="#__codelineno-16-280"></a>        <span class="p">}</span>
</span><span id="__span-16-281"><a id="__codelineno-16-281" name="__codelineno-16-281" href="#__codelineno-16-281"></a>        <span class="nb">Set-AzKeyVaultSecret</span> <span class="nv">@AzKeyVaultSecretParams</span> <span class="p">|</span> <span class="nb">Out-String</span> <span class="p">|</span> <span class="nb">Write-Verbose</span>
</span><span id="__span-16-282"><a id="__codelineno-16-282" name="__codelineno-16-282" href="#__codelineno-16-282"></a>    <span class="p">}</span>
</span><span id="__span-16-283"><a id="__codelineno-16-283" name="__codelineno-16-283" href="#__codelineno-16-283"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span><span id="__span-16-284"><a id="__codelineno-16-284" name="__codelineno-16-284" href="#__codelineno-16-284"></a>    <span class="nb">Write-Host</span> <span class="s2">&quot;ERROR!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Red&#39;</span>
</span><span id="__span-16-285"><a id="__codelineno-16-285" name="__codelineno-16-285" href="#__codelineno-16-285"></a>    <span class="k">throw</span> <span class="nv">$_</span>
</span><span id="__span-16-286"><a id="__codelineno-16-286" name="__codelineno-16-286" href="#__codelineno-16-286"></a><span class="p">}</span>
</span><span id="__span-16-287"><a id="__codelineno-16-287" name="__codelineno-16-287" href="#__codelineno-16-287"></a><span class="nb">Write-Host</span> <span class="s2">&quot;SUCCESS!&quot;</span> <span class="n">-ForegroundColor</span> <span class="s1">&#39;Green&#39;</span>
</span></code></pre></div>
<h2 id="verify-azure-resources">Verify Azure resources</h2>
<p>The final step in terraform management is to make sure that all the azure resources are created as expected, let's quickly review them manually. </p>
<p><a href="../images/image-14.jpg" target="_blank"><img alt="Alt text" src="../images/image-14.jpg" style="border: 1px solid black; border-radius: 10px;" /></a></p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/devops/organizations/projects/create-project?view=azure-devops&amp;tabs=browser" target="_blank">Microsoft MSDN - Create a project in Azure DevOps</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/devops/repos/git/create-new-repo?view=azure-devops" target="_blank">Microsoft MSDN - Create a new Git repo in your project</a></li>
<li><a href="https://learn.microsoft.com/en-us/power-apps/developer/data-platform/walkthrough-register-app-azure-active-directory" target="_blank">Microsoft MSDN - Tutorial: Register an app with Microsoft Entra ID</a></li>
</ul>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../3-azure-account-subscription/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Azure Account &amp; Subscription Management">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Azure Account & Subscription Management
              </div>
            </div>
          </a>
        
        
          
          <a href="../6-tf-foundation-2/" class="md-footer__link md-footer__link--next" aria-label="Next: Setup Terraform Foundation Part-2">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Setup Terraform Foundation Part-2
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 <a href="https://anjikeesari.com/"  target="_blank" rel="noopener">Anji Keesari</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.instagram.com/" target="_blank" rel="noopener" title="www.instagram.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141m0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7m146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8m76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8M398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.annotate", "navigation.indexes", "navigation.footer", "content.tooltips", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "navigation.instant", "navigation.tracking", "header.autohide", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>